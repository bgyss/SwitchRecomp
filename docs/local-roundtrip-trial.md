# Local Round-Trip Trial Runbook

This runbook is a local-only dry run for the `recomp-cli automate` loop. It is designed for
process tuning before any cloud deployment and does not require proprietary assets.

## What This Trial Covers
- Config parsing and path resolution for automation schema v2.
- Pipeline stage on `samples/minimal` plus a no-op build command (`true`) for deterministic local loop testing.
- Deterministic capture/hash validation wiring.
- Retry-loop behavior (`attempt 000` fail, `attempt 001` pass by default).
- Gate and triage artifact inspection.

## Files Used
- `samples/automation.local-roundtrip.toml`
- `samples/local-roundtrip/reference_video.toml`
- `samples/local-roundtrip/capture_video.toml`
- `samples/local-roundtrip/validation_config.toml`
- `samples/local-roundtrip/input_script.toml`
- `scripts/local_roundtrip_trial.sh`

## Prerequisite Checks
Run from repository root.

```bash
cargo --version
cargo run -p recomp-cli -- --help >/dev/null
cargo run -p recomp-validation -- --help >/dev/null
test -f samples/automation.local-roundtrip.toml
```

If any command fails, fix that first (toolchain/install/path issue).

## Trial Execution (Default Retry Simulation)
The helper script prepares deterministic fixtures, runs automation, and prints a summary.

```bash
scripts/local_roundtrip_trial.sh run
```

Equivalent manual sequence:

```bash
scripts/local_roundtrip_trial.sh setup
cargo run -p recomp-cli -- automate --config samples/automation.local-roundtrip.toml
scripts/local_roundtrip_trial.sh inspect
```

## Expected Artifacts
All trial outputs are local and ephemeral under `out/local-roundtrip-trial/`.

- Run-level:
  - `out/local-roundtrip-trial/work/run-manifest.json`
  - `out/local-roundtrip-trial/work/run-summary.json`
- Attempt-level:
  - `out/local-roundtrip-trial/work/attempts/000/attempt-manifest.json`
  - `out/local-roundtrip-trial/work/attempts/000/gate-results.json`
  - `out/local-roundtrip-trial/work/attempts/000/triage.json`
  - `out/local-roundtrip-trial/work/attempts/001/attempt-manifest.json`
  - `out/local-roundtrip-trial/work/attempts/001/gate-results.json`
  - `out/local-roundtrip-trial/work/attempts/001/triage.json`
- Validation reports:
  - `out/local-roundtrip-trial/work/attempts/000/validation/validation-report.json`
  - `out/local-roundtrip-trial/work/attempts/001/validation/validation-report.json`

## Pass/Fail Interpretation
Default mode is `LOCAL_TRIAL_CAPTURE_MODE=fail_once_then_pass`.

Expected outcome:
- Attempt 000: hash gate fails.
- Attempt 001: hash gate passes after retry strategy mutation.
- Final run status: `passed`.

Check quickly:

```bash
jq '{status, attempts, winning_attempt}' out/local-roundtrip-trial/work/run-summary.json
jq '{final_status, attempts: [.attempts[] | {attempt, status, strategy}]}' out/local-roundtrip-trial/work/run-manifest.json
```

Without `jq`:

```bash
rg -n '"status"|"attempts"|"winning_attempt"|"final_status"' out/local-roundtrip-trial/work/run-summary.json out/local-roundtrip-trial/work/run-manifest.json
```

Status meaning:
- `passed`: at least one attempt passed all enabled gates.
- `failed`: an attempt failed and loop ended before retry budget was consumed.
- `needs_review`: run halted by policy/runtime condition or perceptual-only failure path.
- `exhausted`: retry budget consumed without a passing attempt.

## Simulating Retry Loop Variants
Set `LOCAL_TRIAL_CAPTURE_MODE` before `run`.

Always fail (exercise full retry budget + triage):

```bash
LOCAL_TRIAL_CAPTURE_MODE=always_fail scripts/local_roundtrip_trial.sh run
```

Always pass (single-attempt success path):

```bash
LOCAL_TRIAL_CAPTURE_MODE=always_pass scripts/local_roundtrip_trial.sh run
```

In retry runs, inspect the mutated replay script generated by `input_timing_variant`:

```bash
cat out/local-roundtrip-trial/work/attempts/001/mutations/input_script.toml
```

## Inspecting Gates and Triage Outputs
Gate details for an attempt:

```bash
cat out/local-roundtrip-trial/work/attempts/000/gate-results.json
```

Triage classification and next strategy hint:

```bash
cat out/local-roundtrip-trial/work/attempts/000/triage.json
```

Validation failure reasons from hash/video suite:

```bash
cat out/local-roundtrip-trial/work/attempts/000/validation/validation-report.json
```

## Troubleshooting
- `capture video path mismatch`: `samples/automation.local-roundtrip.toml` and `samples/local-roundtrip/capture_video.toml` must refer to the same resolved capture video path.
- `hash list ... is empty`: rerun `scripts/local_roundtrip_trial.sh setup` to regenerate fixture frames and reference hashes.
- `commands.build/run/capture/extract_frames must be non-empty`: config command array is missing one required command.
- `module.json not found` or `provenance path not found`: verify the sample input paths in `samples/automation.local-roundtrip.toml`.
- `unsupported strategy id`: keep `loop.strategy_order` to implemented IDs only.

## Cleanup
To remove local trial outputs:

```bash
rm -rf out/local-roundtrip-trial
```
